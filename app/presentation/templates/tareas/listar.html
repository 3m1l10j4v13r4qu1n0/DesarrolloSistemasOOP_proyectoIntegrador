{% extends "layout.html" %}
{% block title %}Tareas{% endblock %}
{% block content %}
<div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:#667eea;">Lista de Tareas {% if proyecto %}- {{ proyecto.nombre }}{% endif %}</h2>
        {% if proyecto %}
        <a href="{{ url_for('proyectos.detalle', id_proyecto=proyecto.id_proyecto) }}" class="btn btn-info">
            <i class="bi bi-folder"></i> Ver Proyecto
        </a>
        {% endif %}
    </div>

    {% include 'partials/_header.html' %}

    <div style="margin-bottom:20px;">
        <a href="{{ url_for('tareas.nuevo') }}" class="btn btn-primary">Crear una nueva Tarea</a>

        {% if not proyecto %}
        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-filter"></i> Filtrar por Estado
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('tareas.listar') }}">Todas</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('tareas.listar') }}?estado=pendiente">Pendientes</a></li>
                <li><a class="dropdown-item" href="{{ url_for('tareas.listar') }}?estado=en_progreso">En Progreso</a></li>
                <li><a class="dropdown-item" href="{{ url_for('tareas.listar') }}?estado=completada">Completadas</a></li>
                <li><a class="dropdown-item" href="{{ url_for('tareas.listar') }}?estado=bloqueada">Bloqueadas</a></li>
            </ul>
        </div>
        {% endif %}
    </div>

    {% if tareas %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Proyecto</th>
                <th>Asignado a</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Fecha Creación</th>
                <th>Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for tarea in tareas %}
            <tr>
                <td>{{ tarea.id_tarea }}</td>
                <td>
                    <strong>{{ tarea.titulo }}</strong>
                    {% if tarea.descripcion %}
                    <br><small class="text-muted">{{ tarea.descripcion[:50] }}{% if tarea.descripcion|length > 50 %}...{% endif %}</small>
                    {% endif %}
                </td>
                <td>
                    {% if tarea.id_proyecto %}
                        <span>Proyecto {{ tarea.id_proyecto }}</span>
                    {% else %}
                        <span class="text-muted">No asignado</span>
                    {% endif %}
                </td>
                <td>
                    {% if tarea.id_miembro_asignado %}
                        <span>Miembro {{ tarea.id_miembro_asignado }}</span>
                    {% else %}
                        <span class="text-muted">Sin asignar</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if tarea.prioridad=='urgente' %}bg-danger{% elif tarea.prioridad=='alta' %}bg-warning text-dark{% elif tarea.prioridad=='media' %}bg-info{% else %}bg-secondary{% endif %}">
                        {{ tarea.prioridad|capitalize }}
                    </span>
                </td>
                <td>
                    <span class="badge {% if tarea.estado=='completada' %}bg-success{% elif tarea.estado=='en_progreso' %}bg-primary{% elif tarea.estado=='bloqueada' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ tarea.estado|replace('_',' ')|capitalize }}
                    </span>
                </td>
                <td>{{ tarea.fecha_creacion if tarea.fecha_creacion else '-' }}</td>
                <td>{{ tarea.fecha_vencimiento if tarea.fecha_vencimiento else '-' }}</td>
                <td>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <a href="{{ url_for('tareas.detalle', id_tarea=tarea.id_tarea) }}" class="btn btn-ver">Ver</a>
                        <a href="{{ url_for('tareas.editar', id_tarea=tarea.id_tarea) }}" class="btn btn-editar">Editar</a>

                        <form method="POST" action="{{ url_for('tareas.cambiar_estado', id_tarea=tarea.id_tarea) }}" style="display:inline;">
                            <select name="estado" onchange="this.form.submit()" class="form-select form-select-sm" style="width:120px;">
                                <option value="pendiente" {% if tarea.estado=='pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="en_progreso" {% if tarea.estado=='en_progreso' %}selected{% endif %}>En Progreso</option>
                                <option value="completada" {% if tarea.estado=='completada' %}selected{% endif %}>Completada</option>
                                <option value="bloqueada" {% if tarea.estado=='bloqueada' %}selected{% endif %}>Bloqueada</option>
                            </select>
                        </form>

                        <form method="POST" action="{{ url_for('tareas.eliminar', id_tarea=tarea.id_tarea) }}" style="display:inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('¿Estás seguro de eliminar esta tarea?')">Eliminar</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align:center; color:#666; margin:40px 0;">
        {% if proyecto %}No hay tareas en este proyecto. ¡Crea la primera!{% else %}No hay tareas registradas. ¡Crea la primera!{% endif %}
    </p>
    {% endif %}
</div>

<style>
table{width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1);} 
table th{background:#667eea; color:white; padding:12px 15px; text-align:left; font-weight:600;} 
table td{padding:12px 15px; border-bottom:1px solid #e9ecef;} 
table tr:hover{background-color:#f8f9fa;} 
.btn-ver{background:#28a745; color:white; padding:6px 12px; border:none; border-radius:4px; text-decoration:none; font-size:14px;} 
.btn-editar{background:#ffc107; color:black; padding:6px 12px; border:none; border-radius:4px; text-decoration:none; font-size:14px;} 
.btn-ver:hover,.btn-editar:hover{opacity:0.9; transform:translateY(-1px);} 
.badge{font-size:12px; padding:4px 8px; border-radius:12px;} 
.form-select-sm{font-size:12px; padding:4px 8px;} 
</style>
{% endblock %}
